<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRP ì‹œìŠ¤í…œ - íŒŒì¼ ì—…ë¡œë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .gradient-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .upload-zone { border: 2px dashed #d1d5db; transition: all 0.2s; }
        .upload-zone:hover, .upload-zone.drag-over { border-color: #6366f1; background-color: #eef2ff; }
        .file-card { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ===== Supabase ì„¤ì • =====
        const SUPABASE_URL = 'https://vnhjfbcufmbbhwevzunc.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_HZaiacrqOyKPgzUC7RRpXQ_ff3gQp0D';

        let supabase = null;
        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
        } catch (e) {
            console.error('Supabase ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
        }

        // ì•„ì´ì½˜
        const Icons = {
            Upload: () => <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
            File: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
            Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
            X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
            Trash: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Download: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            Table: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>,
            ArrowRight: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        };

        // íŒŒì¼ ìœ í˜• ì •ì˜
        const FILE_TYPES = {
            bom: { name: 'BOM (ìì¬ëª…ì„¸ì„œ)', icon: 'ğŸ“‹', color: 'blue', required: ['ëª¨í’ˆë²ˆ', 'ìí’ˆë²ˆ', 'ë ˆë²¨'] },
            inventory: { name: 'ì¬ê³  í˜„í™©', icon: 'ğŸ“¦', color: 'green', required: ['í’ˆë²ˆ', 'ì¬ê³ ìˆ˜ëŸ‰'] },
            sales: { name: 'ì˜ì—…ê³„íš', icon: 'ğŸ“Š', color: 'purple', required: ['í’ˆë²ˆ', 'ê³„íšìˆ˜ëŸ‰'] }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [files, setFiles] = useState({ bom: null, inventory: null, sales: null });
            const [fileData, setFileData] = useState({ bom: null, inventory: null, sales: null });
            const [previewData, setPreviewData] = useState(null);
            const [dragOver, setDragOver] = useState(null);
            const [processing, setProcessing] = useState(false);

            // ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
            useEffect(() => {
                const checkAuth = async () => {
                    // ë°ëª¨ ëª¨ë“œ ì²´í¬
                    const demoMode = localStorage.getItem('mrp_demo_mode');
                    if (demoMode === 'true') {
                        const demoUser = JSON.parse(localStorage.getItem('mrp_user') || '{}');
                        setUser(demoUser);
                        loadSavedFiles();
                        return;
                    }

                    if (!supabase) {
                        window.location.href = 'login.html';
                        return;
                    }

                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) {
                        window.location.href = 'login.html';
                        return;
                    }
                    setUser(session.user);
                    loadSavedFiles();
                };
                checkAuth();
            }, []);

            // ì €ì¥ëœ íŒŒì¼ ë°ì´í„° ë¡œë“œ
            const loadSavedFiles = () => {
                const savedBom = localStorage.getItem('mrp_bom_data');
                const savedInventory = localStorage.getItem('mrp_inventory_data');
                const savedSales = localStorage.getItem('mrp_sales_data');

                if (savedBom) setFileData(prev => ({ ...prev, bom: JSON.parse(savedBom) }));
                if (savedInventory) setFileData(prev => ({ ...prev, inventory: JSON.parse(savedInventory) }));
                if (savedSales) setFileData(prev => ({ ...prev, sales: JSON.parse(savedSales) }));
            };

            // ë¡œê·¸ì•„ì›ƒ
            const handleLogout = async () => {
                localStorage.removeItem('mrp_demo_mode');
                localStorage.removeItem('mrp_user');
                if (supabase) {
                    await supabase.auth.signOut();
                }
                window.location.href = 'login.html';
            };

            // íŒŒì¼ ë“œë¡­ ì²˜ë¦¬
            const handleDrop = async (e, type) => {
                e.preventDefault();
                setDragOver(null);

                const file = e.dataTransfer?.files[0] || e.target.files[0];
                if (!file) return;

                if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    alert('Excel ë˜ëŠ” CSV íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                setProcessing(true);
                try {
                    const data = await parseExcelFile(file);
                    setFiles(prev => ({ ...prev, [type]: file }));
                    setFileData(prev => ({ ...prev, [type]: { name: file.name, rows: data.length, data: data } }));

                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    localStorage.setItem(`mrp_${type}_data`, JSON.stringify({ name: file.name, rows: data.length, data: data }));
                } catch (error) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    setProcessing(false);
                }
            };

            // Excel íŒŒì¼ íŒŒì‹±
            const parseExcelFile = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(e.target.result, { type: 'array' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const data = XLSX.utils.sheet_to_json(firstSheet);
                            resolve(data);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            };

            // íŒŒì¼ ì‚­ì œ
            const handleDelete = (type) => {
                setFiles(prev => ({ ...prev, [type]: null }));
                setFileData(prev => ({ ...prev, [type]: null }));
                localStorage.removeItem(`mrp_${type}_data`);
            };

            // ë¯¸ë¦¬ë³´ê¸°
            const handlePreview = (type) => {
                if (fileData[type]?.data) {
                    setPreviewData({ type, data: fileData[type].data.slice(0, 100) });
                }
            };

            // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            const handleDownload = (type) => {
                if (!fileData[type]?.data) return;
                const ws = XLSX.utils.json_to_sheet(fileData[type].data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                XLSX.writeFile(wb, `${type}_data.xlsx`);
            };

            // MRP ë¶„ì„ í˜ì´ì§€ë¡œ ì´ë™
            const goToMRP = () => {
                if (!fileData.bom || !fileData.inventory || !fileData.sales) {
                    alert('ëª¨ë“  íŒŒì¼(BOM, ì¬ê³ , ì˜ì—…ê³„íš)ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }
                window.location.href = 'mrp.html';
            };

            // íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
            const FileUploadCard = ({ type }) => {
                const fileRef = useRef(null);
                const info = FILE_TYPES[type];
                const data = fileData[type];

                return (
                    <div className={`bg-white rounded-xl shadow-sm overflow-hidden border-2 ${data ? `border-${info.color}-200` : 'border-transparent'}`}>
                        <div className={`px-4 py-3 bg-${info.color}-50 border-b flex items-center justify-between`}>
                            <div className="flex items-center gap-2">
                                <span className="text-2xl">{info.icon}</span>
                                <div>
                                    <h3 className="font-semibold text-gray-800">{info.name}</h3>
                                    <p className="text-xs text-gray-500">í•„ìˆ˜ ì»¬ëŸ¼: {info.required.join(', ')}</p>
                                </div>
                            </div>
                            {data && (
                                <span className={`px-2 py-1 bg-${info.color}-100 text-${info.color}-700 rounded-full text-xs font-medium`}>
                                    ì—…ë¡œë“œ ì™„ë£Œ
                                </span>
                            )}
                        </div>

                        <div className="p-4">
                            {!data ? (
                                <div
                                    className={`upload-zone rounded-lg p-8 text-center cursor-pointer ${dragOver === type ? 'drag-over' : ''}`}
                                    onDragOver={(e) => { e.preventDefault(); setDragOver(type); }}
                                    onDragLeave={() => setDragOver(null)}
                                    onDrop={(e) => handleDrop(e, type)}
                                    onClick={() => fileRef.current?.click()}
                                >
                                    <input
                                        ref={fileRef}
                                        type="file"
                                        accept=".xlsx,.xls,.csv"
                                        className="hidden"
                                        onChange={(e) => handleDrop(e, type)}
                                    />
                                    <div className="text-gray-400 mb-2 flex justify-center">
                                        <Icons.Upload />
                                    </div>
                                    <p className="text-gray-600 font-medium">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
                                    <p className="text-gray-400 text-sm mt-1">Excel (.xlsx, .xls) ë˜ëŠ” CSV íŒŒì¼</p>
                                </div>
                            ) : (
                                <div className="file-card">
                                    <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <div className={`p-2 bg-${info.color}-100 rounded-lg text-${info.color}-600`}>
                                                <Icons.File />
                                            </div>
                                            <div>
                                                <p className="font-medium text-gray-800">{data.name}</p>
                                                <p className="text-sm text-gray-500">{data.rows.toLocaleString()} í–‰</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button
                                                onClick={() => handlePreview(type)}
                                                className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                title="ë¯¸ë¦¬ë³´ê¸°"
                                            >
                                                <Icons.Table />
                                            </button>
                                            <button
                                                onClick={() => handleDownload(type)}
                                                className="p-2 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                                title="ë‹¤ìš´ë¡œë“œ"
                                            >
                                                <Icons.Download />
                                            </button>
                                            <button
                                                onClick={() => handleDelete(type)}
                                                className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                                title="ì‚­ì œ"
                                            >
                                                <Icons.Trash />
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                            <p className="text-gray-600">ë¡œë”© ì¤‘...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* í—¤ë” */}
                    <header className="gradient-header text-white shadow-lg">
                        <div className="max-w-6xl mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <span className="text-3xl">ğŸ“¦</span>
                                    <div>
                                        <h1 className="text-xl font-bold">MRP ì‹œìŠ¤í…œ</h1>
                                        <p className="text-white/80 text-sm">íŒŒì¼ ì—…ë¡œë“œ</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <nav className="flex gap-2">
                                        <a href="upload.html" className="px-4 py-2 bg-white/20 rounded-lg text-sm font-medium">íŒŒì¼ ì—…ë¡œë“œ</a>
                                        <a href="mrp.html" className="px-4 py-2 hover:bg-white/10 rounded-lg text-sm font-medium transition-colors">MRP ë¶„ì„</a>
                                    </nav>
                                    <div className="h-6 w-px bg-white/30"></div>
                                    <span className="text-sm">{user.name || user.email}</span>
                                    <button onClick={handleLogout} className="p-2 hover:bg-white/10 rounded-lg transition-colors">
                                        <Icons.Logout />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* ë©”ì¸ ì½˜í…ì¸  */}
                    <main className="max-w-6xl mx-auto px-6 py-8">
                        {/* ì§„í–‰ ìƒíƒœ */}
                        <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
                            <h2 className="text-lg font-semibold mb-4">ì—…ë¡œë“œ ì§„í–‰ ìƒíƒœ</h2>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    {Object.entries(FILE_TYPES).map(([type, info], idx) => (
                                        <React.Fragment key={type}>
                                            <div className={`flex items-center gap-2 px-4 py-2 rounded-lg ${
                                                fileData[type] ? `bg-${info.color}-100 text-${info.color}-700` : 'bg-gray-100 text-gray-500'
                                            }`}>
                                                {fileData[type] ? <Icons.Check /> : <span className="w-5 h-5 rounded-full border-2 border-current"></span>}
                                                <span className="font-medium">{info.name}</span>
                                            </div>
                                            {idx < 2 && <div className="w-8 h-px bg-gray-300"></div>}
                                        </React.Fragment>
                                    ))}
                                </div>
                                <button
                                    onClick={goToMRP}
                                    disabled={!fileData.bom || !fileData.inventory || !fileData.sales}
                                    className="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                >
                                    MRP ë¶„ì„ ì‹œì‘ <Icons.ArrowRight />
                                </button>
                            </div>
                        </div>

                        {/* íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <FileUploadCard type="bom" />
                            <FileUploadCard type="inventory" />
                            <FileUploadCard type="sales" />
                        </div>

                        {/* ì•ˆë‚´ */}
                        <div className="mt-6 bg-blue-50 rounded-xl p-6">
                            <h3 className="font-semibold text-blue-800 mb-2">ğŸ“Œ íŒŒì¼ ì—…ë¡œë“œ ì•ˆë‚´</h3>
                            <ul className="text-sm text-blue-700 space-y-1">
                                <li>â€¢ <strong>BOM íŒŒì¼</strong>: ëª¨í’ˆë²ˆ, ìí’ˆë²ˆ, ë ˆë²¨, ì†Œìš”ëŸ‰ ë“± ìì¬ëª…ì„¸ ì •ë³´</li>
                                <li>â€¢ <strong>ì¬ê³  íŒŒì¼</strong>: í’ˆë²ˆ, ì¬ê³ ìˆ˜ëŸ‰, í’ˆëª… ë“± í˜„ì¬ ì¬ê³  ì •ë³´</li>
                                <li>â€¢ <strong>ì˜ì—…ê³„íš íŒŒì¼</strong>: í’ˆë²ˆ, ê³„íšìˆ˜ëŸ‰, ê³ ê°ì‚¬ ë“± ì˜ì—… ê³„íš ì •ë³´</li>
                                <li>â€¢ ì—…ë¡œë“œëœ ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ë©°, ë¡œê·¸ì•„ì›ƒ ì‹œì—ë„ ìœ ì§€ë©ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                    </main>

                    {/* ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ */}
                    {previewData && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setPreviewData(null)}>
                            <div className="bg-white rounded-xl max-w-5xl w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="flex items-center justify-between px-6 py-4 border-b">
                                    <h3 className="font-semibold text-lg">
                                        {FILE_TYPES[previewData.type].icon} {FILE_TYPES[previewData.type].name} ë¯¸ë¦¬ë³´ê¸°
                                        <span className="text-sm text-gray-500 ml-2">(ì²˜ìŒ 100í–‰)</span>
                                    </h3>
                                    <button onClick={() => setPreviewData(null)} className="p-2 hover:bg-gray-100 rounded-lg">
                                        <Icons.X />
                                    </button>
                                </div>
                                <div className="overflow-auto max-h-[60vh]">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-50 sticky top-0">
                                            <tr>
                                                {previewData.data[0] && Object.keys(previewData.data[0]).map(key => (
                                                    <th key={key} className="px-4 py-3 text-left font-medium text-gray-700 whitespace-nowrap">{key}</th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {previewData.data.map((row, idx) => (
                                                <tr key={idx} className="border-b hover:bg-gray-50">
                                                    {Object.values(row).map((val, i) => (
                                                        <td key={i} className="px-4 py-2 whitespace-nowrap">{String(val ?? '')}</td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="px-6 py-4 border-t bg-gray-50 flex justify-end">
                                    <button
                                        onClick={() => handleDownload(previewData.type)}
                                        className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                                    >
                                        <Icons.Download /> Excel ë‹¤ìš´ë¡œë“œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ */}
                    {processing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-8 text-center">
                                <div className="animate-spin w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                                <p className="text-gray-700 font-medium">íŒŒì¼ ì²˜ë¦¬ ì¤‘...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

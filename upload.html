<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRP ì‹œìŠ¤í…œ - íŒŒì¼ ì—…ë¡œë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        .gradient-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .upload-zone { border: 2px dashed #d1d5db; transition: all 0.2s; }
        .upload-zone:hover { border-color: #6366f1; background-color: #eef2ff; }
        .upload-zone.dragover { border-color: #6366f1; background-color: #eef2ff; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <header class="gradient-header text-white p-4 shadow-lg">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸ“¦</span>
                <div>
                    <h1 class="text-xl font-bold">MRP ì‹œìŠ¤í…œ</h1>
                    <p class="text-sm text-white/80">íŒŒì¼ ì—…ë¡œë“œ</p>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="mrp.html" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">MRP ë¶„ì„</a>
                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500/80 rounded-lg hover:bg-red-600">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6">
        <div id="loading" class="hidden text-center py-4">
            <div class="inline-flex items-center gap-2 text-indigo-600">
                <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>ë°ì´í„° ì²˜ë¦¬ ì¤‘...</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“‹</span>
                    <h3 class="font-bold">BOM (ìì¬ëª…ì„¸ì„œ)</h3>
                </div>
                <div id="bom-zone" class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                     onclick="document.getElementById('bom-input').click()"
                     ondrop="handleDrop(event,'bom')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p class="text-gray-500">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p class="text-xs text-gray-400 mt-2">í•„ìˆ˜: ëª¨í’ˆë²ˆ, ìí’ˆë²ˆ, ë ˆë²¨</p>
                </div>
                <input type="file" id="bom-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event,'bom')">
                <div id="bom-info" class="mt-4 hidden"></div>
            </div>

            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“¦</span>
                    <h3 class="font-bold">ì¬ê³  í˜„í™©</h3>
                </div>
                <div id="inventory-zone" class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                     onclick="document.getElementById('inv-input').click()"
                     ondrop="handleDrop(event,'inventory')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p class="text-gray-500">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p class="text-xs text-gray-400 mt-2">í•„ìˆ˜: í’ˆë²ˆ, ì¬ê³ ìˆ˜ëŸ‰</p>
                </div>
                <input type="file" id="inv-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event,'inventory')">
                <div id="inventory-info" class="mt-4 hidden"></div>
            </div>

            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“Š</span>
                    <h3 class="font-bold">ì˜ì—…ê³„íš</h3>
                </div>
                <div id="sales-zone" class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                     onclick="document.getElementById('sales-input').click()"
                     ondrop="handleDrop(event,'sales')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p class="text-gray-500">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p class="text-xs text-gray-400 mt-2">í•„ìˆ˜: í’ˆë²ˆ, ê³„íšìˆ˜ëŸ‰</p>
                </div>
                <input type="file" id="sales-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event,'sales')">
                <div id="sales-info" class="mt-4 hidden"></div>
            </div>
        </div>

        <div class="text-center">
            <button onclick="goToMRP()" class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 shadow-lg">
                MRP ë¶„ì„ ì‹œì‘ â†’
            </button>
        </div>
    </main>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://vnhjfbcufmbbhwevzunc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaGpmYmN1Zm1iYmh3ZXZ6dW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzE2NDEsImV4cCI6MjA4NTUwNzY0MX0.ZZFMYH172ByFDOpBNH_4ehsDNoKMqmLIvdhiCv_27Zo';

        let supabaseClient = null;
        const uploadedData = { bom: null, inventory: null, sales: null };

        // Supabase ì´ˆê¸°í™”
        function initSupabase() {
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase ì´ˆê¸°í™” ì™„ë£Œ');
                loadSavedData();
                return true;
            }
            return false;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Supabase ì´ˆê¸°í™”
        if (!initSupabase()) {
            const interval = setInterval(() => {
                if (initSupabase()) clearInterval(interval);
            }, 100);
            setTimeout(() => clearInterval(interval), 5000);
        }

        // Auth check
        if (!localStorage.getItem('mrp_demo_mode')) {
            window.location.href = 'login.html';
        }

        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSavedData() {
            if (!supabaseClient) return;

            showLoading(true);
            try {
                for (const type of ['bom', 'inventory', 'sales']) {
                    const { data, error } = await supabaseClient
                        .from('mrp_data')
                        .select('*')
                        .eq('data_type', type)
                        .order('updated_at', { ascending: false })
                        .limit(1);

                    if (!error && data && data.length > 0) {
                        uploadedData[type] = data[0].data;
                        showFileInfo(type, data[0].data.name || type, data[0].data.rows || data[0].data.data?.length || 0);
                    }
                }
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
            }
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const file = e.dataTransfer?.files[0];
            if (file) processFile(file, type);
        }

        function handleFileSelect(e, type) {
            const file = e.target.files[0];
            if (file) processFile(file, type);
        }

        async function processFile(file, type) {
            if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                alert('Excel/CSV íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            showLoading(true);
            const reader = new FileReader();

            reader.onload = async function(ev) {
                try {
                    const wb = XLSX.read(ev.target.result, { type: 'array' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                    const saveData = {
                        name: file.name,
                        rows: data.length,
                        data: data
                    };

                    // Supabaseì— ì €ì¥
                    if (supabaseClient) {
                        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆë¡œ ì €ì¥
                        await supabaseClient
                            .from('mrp_data')
                            .delete()
                            .eq('data_type', type);

                        const { error } = await supabaseClient
                            .from('mrp_data')
                            .insert({
                                data_type: type,
                                data: saveData
                            });

                        if (error) {
                            console.error('Supabase ì €ì¥ ì˜¤ë¥˜:', error);
                            alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        } else {
                            uploadedData[type] = saveData;
                            showFileInfo(type, file.name, data.length);
                        }
                    } else {
                        alert('Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    }
                } catch (err) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + err.message);
                }
                showLoading(false);
            };

            reader.readAsArrayBuffer(file);
        }

        function showFileInfo(type, name, rows) {
            const el = document.getElementById(type + '-info');
            el.innerHTML = `
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <span class="text-green-700">âœ“ ${name} (${rows}í–‰)</span>
                    <button onclick="deleteFile('${type}')" class="text-red-500 hover:text-red-700">ì‚­ì œ</button>
                </div>
            `;
            el.classList.remove('hidden');
        }

        async function deleteFile(type) {
            showLoading(true);
            if (supabaseClient) {
                await supabaseClient
                    .from('mrp_data')
                    .delete()
                    .eq('data_type', type);
            }
            uploadedData[type] = null;
            document.getElementById(type + '-info').innerHTML = '';
            document.getElementById(type + '-info').classList.add('hidden');
            showLoading(false);
        }

        function goToMRP() {
            if (!uploadedData.bom || !uploadedData.inventory || !uploadedData.sales) {
                alert('ëª¨ë“  íŒŒì¼(BOM, ì¬ê³ , ì˜ì—…ê³„íš)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            window.location.href = 'mrp.html';
        }
    </script>
</body>
</html>
